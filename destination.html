<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Travel Explorer - Destination</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <link rel="stylesheet" href="style.css">
</head>
<body class="antialiased">

    <nav class="sticky top-0 bg-slate-900/80 backdrop-blur-sm shadow z-50">
        <div class="container mx-auto px-6 py-4 flex justify-between items-center">
            <a href="index.html" class="text-2xl font-extrabold text-blue-400">TravelExplorer</a>
            <a href="planner.html" class="font-semibold hover:text-blue-400 transition">My Trip Planner</a>
        </div>
    </nav>
    
    <main class="container mx-auto px-6 py-12">
        <div id="loader" class="flex justify-center items-center py-20">
            <div class="loader"></div>
        </div>
        <div id="search-result-container" class="hidden"></div>
    </main>

    <script>
        const OPENWEATHER_API_KEY = 'efd3517403de79e4e2fd89e80290c2ba';
        const UNSPLASH_ACCESS_KEY = 'qpC66xH8V2eJDOxt5xyFva_L10_EV_jn8kbok13jSMc';
        const GEOAPIFY_API_KEY = 'a2f90c185a3e4ec8855df2ef80d9e328';

        let itinerary = [];
        const loader = document.getElementById('loader');
        const searchResultContainer = document.getElementById('search-result-container');
        let mapInstance = null;
        
        const saveItinerary = () => localStorage.setItem('travelItinerary', JSON.stringify(itinerary));
        const loadItinerary = () => {
            const saved = localStorage.getItem('travelItinerary');
            if (saved) itinerary = JSON.parse(saved);
        };

        // **NEW**: Function to remove an item by name
        const removeFromItineraryByName = (name) => {
            const index = itinerary.findIndex(item => item.name === name);
            if (index > -1) {
                itinerary.splice(index, 1);
            }
        };

        // **UPDATED**: This function now TOGGLES items in the itinerary
        window.toggleItineraryItem = (buttonEl, name, city, type) => {
            const isAdded = itinerary.some(item => item.name === name);

            if (isAdded) {
                // If already added, REMOVE it
                removeFromItineraryByName(name);
                buttonEl.classList.remove('bg-red-500');
                buttonEl.classList.add('bg-green-500', 'hover:bg-green-600');
                buttonEl.innerHTML = '+';
            } else {
                // If not added, ADD it
                itinerary.push({ name, city, type });
                buttonEl.classList.remove('bg-green-500', 'hover:bg-green-600');
                buttonEl.classList.add('bg-red-500');
                buttonEl.innerHTML = '–'; // Use a minus sign for remove
            }
            saveItinerary();
        };
        
        const formatTime = (unix, tz) => new Date((unix + tz) * 1000).toLocaleTimeString('en-US', {hour:'2-digit', minute:'2-digit', timeZone:'UTC'});
        const formatDate = (unix, tz) => new Date((unix + tz) * 1000).toLocaleDateString('en-US', {weekday:'long', month:'long', day:'numeric', timeZone:'UTC'});
        const getWeather = async (city) => (await fetch(`https://api.openweathermap.org/data/2.5/weather?q=${city}&appid=${OPENWEATHER_API_KEY}&units=metric`)).json();
        const getForecast = async (city) => (await fetch(`https://api.openweathermap.org/data/2.5/forecast?q=${city}&appid=${OPENWEATHER_API_KEY}&units=metric`)).json();
        const getPhoto = async (city) => { const res = await fetch(`https://api.unsplash.com/search/photos?query=${city}&per_page=1&orientation=landscape&client_id=${UNSPLASH_ACCESS_KEY}`); return (await res.json()).results[0]?.urls?.regular || 'https://placehold.co/1200x400/1e293b/475569?text=Image+Not+Found'; };
        const getAttractions = async (lat, lon) => (await fetch(`https://api.geoapify.com/v2/places?categories=tourism.attraction&filter=circle:${lon},${lat},5000&limit=15&apiKey=${GEOAPIFY_API_KEY}`)).json();
        const getAccommodations = async (lat, lon) => (await fetch(`https://api.geoapify.com/v2/places?categories=accommodation.hotel,accommodation.motel&filter=circle:${lon},${lat},5000&limit=15&apiKey=${GEOAPIFY_API_KEY}`)).json();

        const displaySearchResult = async (city) => {
            loader.style.display = 'flex';
            searchResultContainer.classList.add('hidden');
            try {
                const weather = await getWeather(city);
                if (weather.cod !== 200) { throw new Error(weather.message); }

                const results = await Promise.allSettled([
                    getForecast(city),
                    getPhoto(city),
                    getAttractions(weather.coord.lat, weather.coord.lon),
                    getAccommodations(weather.coord.lat, weather.coord.lon)
                ]);

                const forecastResult = results[0];
                const photoResult = results[1];
                const attractionsResult = results[2];
                const accommodationsResult = results[3];

                const imageUrl = photoResult.status === 'fulfilled' ? photoResult.value : 'https://placehold.co/1200x400/1e293b/475569?text=Image+Not+Found';
                const { name, sys, main, weather: details, timezone, wind, dt } = weather;
                const flightSearchLink = `https://www.google.com/flights?q=flights+to+${encodeURIComponent(name)}`;

                const weatherCardHtml = `<div class="card p-6 rounded-xl shadow-lg mb-8"><div class="flex justify-between items-start flex-wrap gap-2"><div><h2 class="text-3xl font-bold">${name}, ${sys.country}</h2><p class="text-slate-400">${formatDate(dt, timezone)}</p><p class="text-slate-400">${formatTime(dt, timezone)}</p></div><a href="${flightSearchLink}" target="_blank" class="bg-blue-600 text-white text-sm font-bold py-2 px-4 rounded-lg hover:bg-blue-700 transition">✈️ Find Flights</a></div><div class="flex justify-between items-center mt-4"><div class="text-left"><p class="text-7xl font-extrabold">${Math.round(main.temp)}°C</p><p class="text-slate-400">Feels like ${Math.round(main.feels_like)}°C</p></div><div class="text-right"><img src="https://openweathermap.org/img/wn/${details[0].icon}@2x.png" alt="${details[0].description}" class="w-24 h-24"><p class="capitalize -mt-2">${details[0].description}</p></div></div><div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-center border-t border-slate-700 pt-4 mt-6"><div><p class="text-sm text-slate-400">Humidity</p><p class="font-bold text-lg">${main.humidity}%</p></div><div><p class="text-sm text-slate-400">Wind</p><p class="font-bold text-lg">${wind.speed.toFixed(1)} m/s</p></div><div><p class="text-sm text-slate-400">Pressure</p><p class="font-bold text-lg">${main.pressure} hPa</p></div><div><p class="text-sm text-slate-400">High/Low</p><p class="font-bold text-lg">${Math.round(main.temp_max)}°/${Math.round(main.temp_min)}°</p></div><div class="col-span-2 md:col-span-4 grid grid-cols-2 gap-4 mt-4 border-t border-slate-700 pt-4"><div><p class="text-sm text-slate-400">Sunrise</p><p class="font-bold text-lg">${formatTime(sys.sunrise, timezone)}</p></div><div><p class="text-sm text-slate-400">Sunset</p><p class="font-bold text-lg">${formatTime(sys.sunset, timezone)}</p></div></div></div></div>`;
                
                let forecastHtml = '';
                if (forecastResult.status === 'fulfilled' && forecastResult.value.list) {
                    const dailyForecasts = forecastResult.value.list.filter(r => r.dt_txt.includes("12:00:00"));
                    forecastHtml = `<div class="card p-6 rounded-xl shadow-lg mb-8"><h2 class="text-xl font-bold mb-4">5-Day Forecast</h2><div class="grid grid-cols-5 gap-4">${dailyForecasts.map(day => `<div class="text-center"><p class="font-semibold">${new Date(day.dt*1000).toLocaleDateString('en-US',{weekday:'short'})}</p><img src="https://openweathermap.org/img/wn/${day.weather[0].icon}.png" class="mx-auto"><p class="font-bold">${Math.round(day.main.temp)}°C</p></div>`).join('')}</div></div>`;
                }

                const attractionsData = attractionsResult.status === 'fulfilled' ? attractionsResult.value : null;
                const accommodationsData = accommodationsResult.status === 'fulfilled' ? accommodationsResult.value : null;
                const attractionsHtml = attractionsData?.features?.length > 0 ? `<div id="map" class="w-full h-96 rounded-lg mt-4"></div>` : `<p class="text-center p-8">No attractions found nearby.</p>`;
                
                // **UPDATED**: Button now calls toggleItineraryItem and content is changed
                const hotelsHtml = accommodationsData?.features?.length > 0 ? accommodationsData.features.map(p => { const isAdded = itinerary.some(item => item.name === p.properties.name); const btnClass = isAdded ? 'bg-red-500' : 'bg-green-500 hover:bg-green-600'; return `<div class="flex justify-between items-center border-b last:border-b-0 border-slate-700 py-3"><div><p class="font-bold text-blue-400">${p.properties.name}</p><p class="text-sm text-slate-400">${p.properties.address_line2}</p></div><button onclick="toggleItineraryItem(this, '${p.properties.name.replace(/'/g, "\\'")}', '${name}', 'Hotel')" class="ml-2 flex-shrink-0 text-white rounded-full h-8 w-8 flex items-center justify-center font-bold ${btnClass}">${isAdded ? '–' : '+'}</button></div>` }).join('') : `<p class="text-center p-8">No hotels found nearby.</p>`;
                
                searchResultContainer.innerHTML = `${weatherCardHtml}${forecastHtml}<div class="card p-6 rounded-xl shadow-lg"><div class="flex border-b border-slate-700 mb-4 overflow-x-auto"><button class="tab-button active py-2 px-4 flex-shrink-0" onclick="switchTab(event, 'attractions')">Attractions</button><button class="tab-button py-2 px-4 flex-shrink-0" onclick="switchTab(event, 'hotels')">Hotels</button></div><div id="attractions" class="tab-content">${attractionsHtml}</div><div id="hotels" class="tab-content hidden">${hotelsHtml}</div></div>`;

                if (attractionsData?.features?.length > 0) {
                    setTimeout(() => {
                        if (mapInstance) mapInstance.remove();
                        const greenIcon = new L.Icon({ iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-green.png', shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png', iconSize: [25, 41], iconAnchor: [12, 41], popupAnchor: [1, -34], shadowSize: [41, 41] });
                        mapInstance = L.map('map').setView([weather.coord.lat, weather.coord.lon], 13);
                        L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', { attribution: '&copy; OpenStreetMap &copy; CARTO' }).addTo(mapInstance);
                        
                        attractionsData.features.forEach(p => {
                            const isAdded = itinerary.some(item => item.name === p.properties.name);
                            const btnClass = isAdded ? 'bg-red-500' : 'bg-green-500 hover:bg-green-600';
                            // **UPDATED**: Button content changed
                            const btnContent = isAdded ? '– Remove' : '+ Add to Trip';
                            const popup = `<b>${p.properties.name}</b><br><button onclick="toggleItineraryItem(this, '${p.properties.name.replace(/'/g, "\\'")}', '${name}', 'Attraction')" class="mt-1 text-xs text-white rounded px-2 py-1 ${btnClass}">${btnContent}</button>`;
                            L.marker([p.geometry.coordinates[1], p.geometry.coordinates[0]], {icon: greenIcon}).addTo(mapInstance).bindPopup(popup);
                        });
                    }, 100);
                }
            } catch (error) {
                 searchResultContainer.innerHTML = `<div class="text-center p-10 card rounded-lg"><h2 class="text-2xl font-bold text-red-500">Search Failed</h2><p class="text-red-400 mt-2">Could not find data for "${city}". Please check the spelling and try again.</p><a href="index.html" class="inline-block mt-4 bg-blue-600 text-white font-bold py-2 px-4 rounded">Go Home</a></div>`;
            } finally {
                loader.style.display = 'none';
                searchResultContainer.classList.remove('hidden');
            }
        };
        
        window.switchTab = (event, tabName) => { document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden')); document.querySelectorAll('.tab-button').forEach(el => el.classList.remove('active')); document.getElementById(tabName).classList.remove('hidden'); event.currentTarget.classList.add('active'); if (tabName === 'attractions' && mapInstance) { setTimeout(() => mapInstance.invalidateSize(), 10); } };
        
        document.addEventListener('DOMContentLoaded', () => {
            loadItinerary();
            const city = new URLSearchParams(window.location.search).get('q');
            if (city) {
                displaySearchResult(city);
            } else {
                loader.style.display = 'none';
                searchResultContainer.innerHTML = `<div class="text-center p-10 card rounded-lg"><h2 class="text-2xl font-bold">No city specified.</h2><p>Please search for a city from the homepage.</p><a href="index.html" class="inline-block mt-4 bg-blue-600 text-white font-bold py-2 px-4 rounded">Go Home</a></div>`;
                searchResultContainer.classList.remove('hidden');
            }
        });
    </script>
</body>
</html>